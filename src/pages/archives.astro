---
import Layout from '~/layouts/PageLayout.astro';
import Headline from '~/components/blog/Headline.astro';
import { fetchPosts } from '~/utils/blog';
import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';

export const prerender = true;

const posts = await fetchPosts();

// Group posts by year
const postsByYear: Record<number, typeof posts> = {};
for (const post of posts) {
  const year = post.publishDate.getFullYear();
  if (!postsByYear[year]) postsByYear[year] = [];
  postsByYear[year].push(post);
}

const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);

const metadata = {
  title: 'Archives',
};
---

<Layout metadata={metadata}>
  <div class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 via-white to-purple-50 dark:from-indigo-950/30 dark:via-slate-900 dark:to-purple-950/20"></div>
    <section class="relative px-6 sm:px-6 pt-12 sm:pt-16 lg:pt-20 pb-8 mx-auto max-w-4xl">
      <Headline subtitle={`${posts.length} posts in total`}>
        Archives
      </Headline>
    </section>
  </div>

  <section class="px-6 sm:px-6 py-8 sm:py-12 mx-auto max-w-4xl">
    {years.map((year) => (
      <div class="mb-10">
        <h2 class="text-2xl font-bold font-heading mb-4 text-primary dark:text-indigo-400 flex items-center gap-2">
          <span class="bg-primary/10 dark:bg-indigo-400/10 px-3 py-1 rounded-lg">{year}</span>
          <span class="text-sm font-normal text-muted">({postsByYear[year].length} posts)</span>
        </h2>
        <ul class="border-l-2 border-indigo-200 dark:border-indigo-800 ml-4 space-y-3">
          {postsByYear[year].map((post) => (
            <li class="relative pl-6">
              <span class="absolute left-[-5px] top-2 w-2 h-2 rounded-full bg-indigo-400 dark:bg-indigo-500"></span>
              <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                <time datetime={String(post.publishDate)} class="text-sm text-muted whitespace-nowrap">
                  {getFormattedDate(post.publishDate)}
                </time>
                <a
                  href={getPermalink(post.permalink, 'post')}
                  class="text-default hover:text-primary dark:hover:text-indigo-400 transition-colors duration-200"
                >
                  {post.title}
                </a>
                {post.category && (
                  <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 dark:bg-slate-700 text-muted whitespace-nowrap">
                    {post.category.title}
                  </span>
                )}
              </div>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </section>
</Layout>
