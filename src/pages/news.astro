---
import Layout from "~/layouts/PageLayout.astro";
---

<Layout metadata={{ title: "Finance News Feed" }}>
  <main class="mx-auto max-w-6xl px-4 pb-16 sm:px-6">
    <!-- Hero Header -->
    <div class="mt-6 mb-8 flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-3xl font-extrabold tracking-tight sm:text-4xl">
          <span class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-500 dark:from-indigo-400 dark:via-blue-400 dark:to-cyan-400 bg-clip-text text-transparent">Finance</span>
          <span class="text-default"> News</span>
        </h1>
        <p class="mt-1 text-sm text-muted">Global financial headlines &middot; Updated twice daily</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.xml" target="_blank" rel="noopener"
          class="inline-flex items-center gap-1.5 rounded-lg bg-orange-500/10 px-3 py-1.5 text-xs font-bold text-orange-600 dark:text-orange-400 hover:bg-orange-500/20 transition-colors ring-1 ring-orange-500/20">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
          RSS
        </a>
        <button id="subscribe-toggle"
          class="inline-flex items-center gap-1.5 rounded-lg bg-indigo-500/10 px-3 py-1.5 text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-500/20 transition-colors ring-1 ring-indigo-500/20">
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          Subscribe
        </button>
      </div>
    </div>

    <!-- Subscribe Form (hidden by default) -->
    <div id="subscribe-panel" class="hidden mb-6 rounded-xl border border-indigo-200 dark:border-indigo-800/50 bg-indigo-50/50 dark:bg-indigo-950/20 p-4">
      <form id="subscribe-form" class="flex flex-col gap-2 sm:flex-row">
        <input type="email" id="subscribe-email" placeholder="your@email.com" required
          class="flex-1 rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 focus:outline-none" />
        <button type="submit" class="rounded-lg bg-indigo-600 px-5 py-2 text-sm font-bold text-white hover:bg-indigo-700 transition-colors">Subscribe</button>
      </form>
      <p id="subscribe-msg" class="hidden mt-2 text-sm"></p>
    </div>

    <div id="feed-loading" class="flex flex-col items-center justify-center py-20 text-muted">
      <div class="mb-3 h-8 w-8 animate-spin rounded-full border-2 border-indigo-200 border-t-indigo-600 dark:border-indigo-800 dark:border-t-indigo-400"></div>
      <span class="text-sm">Loading latest news...</span>
    </div>
    <div id="feed-error" class="hidden py-12 text-center">
      <p class="text-red-500 font-semibold">Failed to load news feed.</p>
      <p class="text-sm text-muted mt-1">Please try refreshing the page.</p>
    </div>
    <div id="feed-container" class="hidden space-y-3"></div>
  </main>
</Layout>

<style is:global>
  /* ── Card ── */
  .nc {
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.15);
    background: white;
    overflow: hidden;
  }
  .dark .nc {
    background: rgba(15,23,42,0.6);
    border-color: rgba(148,163,184,0.1);
  }
  .nc-head {
    padding: 14px 18px 10px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.8px;
    font-weight: 800;
    color: #6366f1;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .dark .nc-head { color: #818cf8; }
  .nc-head::before {
    content: "";
    display: inline-block;
    width: 3px; height: 14px;
    border-radius: 2px;
    background: currentColor;
  }
  .nc-body { padding: 0 18px 16px; }

  /* ── Market Cards Grid ── */
  .mkt-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
  }
  .mkt-card {
    border-radius: 10px;
    padding: 10px 12px;
    border: 1px solid rgba(148,163,184,0.1);
    background: linear-gradient(135deg, rgba(249,250,251,0.8), rgba(241,245,249,0.5));
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .dark .mkt-card {
    background: linear-gradient(135deg, rgba(30,41,59,0.5), rgba(15,23,42,0.5));
    border-color: rgba(148,163,184,0.08);
  }
  .mkt-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
  .mkt-name { font-size: 10px; font-weight: 700; opacity: 0.55; text-transform: uppercase; letter-spacing: 0.3px; }
  .mkt-price { font-size: 17px; font-weight: 800; margin-top: 2px; letter-spacing: -0.3px; }
  .mkt-chg { font-size: 11px; font-weight: 600; margin-top: 2px; display: flex; align-items: center; gap: 2px; }
  .mkt-section-label {
    font-size: 11px; font-weight: 700; opacity: 0.4;
    margin: 12px 0 6px; padding-bottom: 4px;
    border-bottom: 1px solid rgba(148,163,184,0.08);
  }
  .mkt-section-label:first-child { margin-top: 0; }

  /* ── Sector Ranking ── */
  .sec-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 13px;
  }
  .sec-row + .sec-row { border-top: 1px solid rgba(148,163,184,0.06); }
  .sec-rank { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; border-radius: 5px; font-size: 10px; font-weight: 800; background: rgba(99,102,241,0.08); color: #6366f1; margin-right: 8px; flex-shrink: 0; }
  .dark .sec-rank { background: rgba(129,140,248,0.12); color: #818cf8; }
  .sec-pct { font-weight: 800; font-size: 13px; font-variant-numeric: tabular-nums; }

  /* ── News Rows ── */
  .nr {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(148,163,184,0.07);
  }
  .nr:last-child { border-bottom: none; }
  .nr:hover { background: rgba(99,102,241,0.02); margin: 0 -18px; padding-left: 18px; padding-right: 18px; }
  .nr-time {
    font-size: 11px;
    font-weight: 600;
    color: rgba(100,116,139,0.6);
    min-width: 42px;
    padding-top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
  }
  .nr-body { flex: 1; min-width: 0; }
  .nr-title {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.45;
    color: inherit;
    text-decoration: none;
    display: block;
    transition: color 0.15s;
  }
  .nr-title:hover { color: #6366f1; }
  .dark .nr-title:hover { color: #818cf8; }
  .nr-zh {
    font-size: 12.5px;
    color: rgba(100,116,139,0.65);
    margin-top: 1px;
    line-height: 1.4;
  }
  .nr-src {
    display: inline-block;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 2px 7px;
    border-radius: 4px;
    background: rgba(99,102,241,0.07);
    color: #6366f1;
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 3px;
  }
  .dark .nr-src { background: rgba(129,140,248,0.1); color: #818cf8; }

  /* ── Summary Text ── */
  .summary-text {
    font-size: 14px;
    line-height: 1.8;
    white-space: pre-line;
    color: var(--aw-color-text-default);
  }

  /* ── Edition Toggle ── */
  .ed-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 14px 18px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.15);
    background: white;
    cursor: pointer;
    font-size: 15px;
    font-weight: 700;
    color: var(--aw-color-text-default, #0f172a);
    transition: all 0.15s;
  }
  .dark .ed-toggle { background: rgba(15,23,42,0.6); border-color: rgba(148,163,184,0.1); color: var(--aw-color-text-default, #e2e8f0); }
  .ed-toggle:hover { border-color: rgba(99,102,241,0.3); }
  .ed-meta { font-size: 12px; font-weight: 400; opacity: 0.45; margin-left: 8px; }
  .ed-arrow { font-size: 10px; opacity: 0.3; transition: transform 0.2s; }
  .ed-arrow.open { transform: rotate(90deg); }
  .ed-body { overflow: hidden; transition: max-height 0.35s ease; }
  .ed-body.collapsed { max-height: 0 !important; }

  /* ── Two-column layout for market + sectors ── */
  @media (min-width: 768px) {
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .two-col > .nc { min-width: 0; }
  }
</style>

<script is:inline>
var FEED_URL = "https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.json";

function fmt(n) {
  if (n == null) return "N/A";
  if (Math.abs(n) >= 1000) return n.toLocaleString("en-US", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  return n.toFixed(2);
}
function fmtChg(c, p) {
  if (c == null || p == null) return "";
  return (c >= 0 ? "+" : "") + fmt(c) + " (" + (p >= 0 ? "+" : "") + p.toFixed(2) + "%)";
}
function esc(t) { if (!t) return ""; var d = document.createElement("div"); d.textContent = t; return d.innerHTML; }
function arrow(v) { return v > 0 ? "&#9650;" : v < 0 ? "&#9660;" : "&#8212;"; }

async function loadFeed() {
  var ld = document.getElementById("feed-loading");
  var er = document.getElementById("feed-error");
  var ct = document.getElementById("feed-container");
  try {
    var r = await fetch(FEED_URL + "?t=" + Date.now());
    if (!r.ok) throw new Error("HTTP " + r.status);
    var feed = await r.json();
    ld.classList.add("hidden");
    var editions = feed.editions && Array.isArray(feed.editions) ? feed.editions : feed.items ? [feed] : [];
    if (!editions.length) { ct.innerHTML = '<p class="py-16 text-center text-muted text-sm">No editions available yet.</p>'; ct.classList.remove("hidden"); return; }
    editions.sort(function(a,b){ return (b.updated_at||"").localeCompare(a.updated_at||""); });

    var html = "";
    for (var idx = 0; idx < editions.length; idx++) {
      var ed = editions[idx], isFirst = idx === 0, edId = "ed-" + idx;
      var dt = ed.updated_at ? new Date(ed.updated_at) : null;
      var dateStr = dt ? dt.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}) + " " + dt.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}) : "";
      var label = ed.edition_label || "Edition";
      var cnt = (ed.items||[]).length;

      if (!isFirst) {
        html += '<div style="margin-top:12px;">';
        html += '<button class="ed-toggle" data-target="' + edId + '"><span>' + esc(label) + '<span class="ed-meta">' + dateStr + ' &middot; ' + cnt + ' items</span></span><span class="ed-arrow">&#9654;</span></button>';
        html += '<div id="' + edId + '" class="ed-body collapsed" style="margin-top:12px;">';
      }

      // Row 1: Outlook + Hotspots / Sector Picks (side by side if both exist)
      var hasOutlook = ed.summary_cn || ed.market_hotspots_cn;
      var hasPicks = ed.sector_recommendation;
      if (hasOutlook || hasPicks) {
        var cols = (hasOutlook && hasPicks) ? ' two-col' : '';
        html += '<div class="' + cols + '">';
        if (hasOutlook) {
          html += '<div class="nc"><div class="nc-head">Daily Outlook</div><div class="nc-body"><div class="summary-text">';
          if (ed.summary_cn) html += esc(ed.summary_cn);
          if (ed.market_hotspots_cn) html += (ed.summary_cn ? '\n\n' : '') + esc(ed.market_hotspots_cn);
          html += '</div></div></div>';
        }
        if (hasPicks) {
          html += '<div class="nc"><div class="nc-head">Sector & Stock Picks</div><div class="nc-body"><div class="summary-text">' + esc(ed.sector_recommendation) + '</div></div></div>';
        }
        html += '</div>';
      }

      // Row 2: Market Snapshot + Sector Rankings (side by side on desktop)
      var hasMarket = ed.market_snapshot && ed.market_snapshot.length;
      var hasSectors = ed.sector_rankings && ed.sector_rankings.length;
      if (hasMarket || hasSectors) {
        html += '<div class="two-col">';
        if (hasMarket) {
          html += '<div class="nc"><div class="nc-head">Market Snapshot</div><div class="nc-body">';
          for (var s = 0; s < ed.market_snapshot.length; s++) {
            var sec = ed.market_snapshot[s];
            html += '<div class="mkt-section-label">' + esc(sec.title) + '</div><div class="mkt-grid">';
            for (var i = 0; i < sec.items.length; i++) {
              var m = sec.items[i];
              var co = m.change_color || (m.change >= 0 ? "#16a34a" : "#dc2626");
              html += '<div class="mkt-card"><div class="mkt-name">' + esc(m.name) + '</div>';
              html += '<div class="mkt-price">' + fmt(m.price) + '</div>';
              if (m.change != null && m.change_percent != null) {
                html += '<div class="mkt-chg" style="color:' + co + '"><span>' + arrow(m.change) + '</span> ' + fmtChg(m.change, m.change_percent) + '</div>';
              }
              html += '</div>';
            }
            html += '</div>';
          }
          html += '</div></div>';
        }
        if (hasSectors) {
          html += '<div class="nc"><div class="nc-head">Sector Rankings</div><div class="nc-body">';
          for (var rr = 0; rr < ed.sector_rankings.length; rr++) {
            var rk = ed.sector_rankings[rr];
            if (ed.sector_rankings.length > 1) html += '<div class="mkt-section-label">' + esc(rk.title) + '</div>';
            for (var ri = 0; ri < rk.items.length; ri++) {
              var si = rk.items[ri], sc = si.change_color || (si.change_percent >= 0 ? "#16a34a" : "#dc2626");
              html += '<div class="sec-row"><span><span class="sec-rank">' + (ri + 1) + '</span>' + esc(si.name) + '</span><span class="sec-pct" style="color:' + sc + '">' + (si.change_percent >= 0 ? "+" : "") + si.change_percent.toFixed(2) + '%</span></div>';
            }
          }
          html += '</div></div>';
        }
        html += '</div>';
      }

      // Row 3: Social media summary
      if (ed.social_summary_cn) {
        html += '<div class="nc"><div class="nc-head">Social Media Digest</div><div class="nc-body"><div class="summary-text">' + esc(ed.social_summary_cn) + '</div></div></div>';
      }

      // Row 4: News items
      if (ed.items && ed.items.length) {
        html += '<div class="nc"><div class="nc-head">Top Briefing (' + ed.items.length + ')</div><div class="nc-body">';
        for (var j = 0; j < ed.items.length; j++) {
          var it = ed.items[j];
          var tEn = it.title_en || it.title || "";
          var tZh = it.title_zh || "";
          var tm = "";
          if (it.published) { var dd = new Date(it.published), hh = dd.getHours(), mm = dd.getMinutes(); tm = (hh < 10 ? "0" : "") + hh + ":" + (mm < 10 ? "0" : "") + mm; }
          html += '<div class="nr"><div class="nr-time">' + tm + '</div><div class="nr-body">';
          html += '<a class="nr-title" href="' + esc(it.link) + '" target="_blank" rel="noopener">' + esc(tEn) + '</a>';
          if (tZh && tZh !== tEn) html += '<div class="nr-zh">' + esc(tZh) + '</div>';
          html += '</div><div class="nr-src">' + esc(it.source) + '</div></div>';
        }
        html += '</div></div>';
      }

      // Social media links
      if (ed.social_media && ed.social_media.length) {
        html += '<div class="nc"><div class="nc-head">Social Media</div><div class="nc-body">';
        for (var sg = 0; sg < ed.social_media.length; sg++) {
          var grp = ed.social_media[sg];
          html += '<div class="mkt-section-label">' + esc(grp.platform) + '</div>';
          for (var gi = 0; gi < grp.items.length; gi++) {
            var sit = grp.items[gi];
            var stEn = sit.title_en || sit.title || "";
            var stZh = sit.title_zh || "";
            html += '<div class="nr"><div class="nr-body">';
            html += '<a class="nr-title" href="' + esc(sit.link) + '" target="_blank" rel="noopener">' + esc(stEn) + '</a>';
            if (stZh && stZh !== stEn) html += '<div class="nr-zh">' + esc(stZh) + '</div>';
            html += '</div></div>';
          }
        }
        html += '</div></div>';
      }

      if (!isFirst) html += '</div></div>';
    }

    ct.innerHTML = html;
    ct.classList.remove("hidden");
    var toggles = ct.querySelectorAll(".ed-toggle");
    for (var t = 0; t < toggles.length; t++) toggles[t].addEventListener("click", handleToggle);
  } catch(e) { console.error(e); ld.classList.add("hidden"); er.classList.remove("hidden"); }
}

function handleToggle(e) {
  var btn = e.currentTarget, id = btn.getAttribute("data-target");
  var body = document.getElementById(id), arr = btn.querySelector(".ed-arrow");
  if (!body) return;
  if (body.classList.contains("collapsed")) {
    body.classList.remove("collapsed"); body.style.maxHeight = body.scrollHeight + "px";
    if (arr) arr.classList.add("open");
  } else {
    body.style.maxHeight = body.scrollHeight + "px"; body.offsetHeight;
    body.classList.add("collapsed"); body.style.maxHeight = "0";
    if (arr) arr.classList.remove("open");
  }
}

loadFeed();

// Subscribe toggle
var stBtn = document.getElementById("subscribe-toggle");
var stPanel = document.getElementById("subscribe-panel");
if (stBtn && stPanel) stBtn.addEventListener("click", function() { stPanel.classList.toggle("hidden"); });

// Subscribe form
var sf = document.getElementById("subscribe-form");
if (sf) sf.addEventListener("submit", function(e) {
  e.preventDefault();
  var ei = document.getElementById("subscribe-email"), msg = document.getElementById("subscribe-msg"), em = ei.value.trim();
  if (!em) return;
  msg.textContent = "Subscribing..."; msg.className = "mt-2 text-sm text-muted"; msg.classList.remove("hidden");
  fetch("/api/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:em})})
    .then(function(r){return r.json();})
    .then(function(d){ if(d.ok){msg.textContent="Subscribed!";msg.className="mt-2 text-sm text-green-600";ei.value="";}else{msg.textContent=d.error||"Failed.";msg.className="mt-2 text-sm text-red-500";}})
    .catch(function(){msg.textContent="Network error.";msg.className="mt-2 text-sm text-red-500";});
});
</script>
