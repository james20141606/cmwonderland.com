---
import Layout from "~/layouts/PageLayout.astro";
---

<Layout metadata={{ title: "Finance News Feed" }}>
  <main class="mx-auto max-w-4xl px-4 pb-12 sm:px-6">
    <h1 class="pt-8 pb-2 text-2xl font-semibold sm:text-3xl">Finance News Feed</h1>
    <div class="mb-6 flex flex-wrap items-center gap-4">
      <p class="italic opacity-75">Global financial headlines, updated twice daily.</p>
      <a
        href="https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.xml"
        target="_blank"
        rel="noopener"
        class="inline-flex items-center gap-1 rounded-md bg-orange-500 px-3 py-1 text-xs font-semibold text-white hover:bg-orange-600"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
        RSS
      </a>
    </div>

    <!-- Email subscription form -->
    <div id="subscribe-section" class="mb-8 rounded-lg border border-border p-4">
      <h3 class="mb-2 text-sm font-semibold uppercase tracking-wider opacity-70">Subscribe to email digest</h3>
      <form id="subscribe-form" class="flex flex-col gap-2 sm:flex-row">
        <input
          type="email"
          id="subscribe-email"
          placeholder="your@email.com"
          required
          class="flex-1 rounded-md border border-border bg-background px-3 py-2 text-sm text-foreground placeholder:opacity-50 focus:border-accent focus:outline-none"
        />
        <button
          type="submit"
          class="rounded-md bg-accent px-4 py-2 text-sm font-semibold text-white hover:opacity-90"
        >
          Subscribe
        </button>
      </form>
      <p id="subscribe-msg" class="mt-2 hidden text-sm"></p>
    </div>

    <div id="feed-loading" class="py-12 text-center opacity-60">
      Loading latest news...
    </div>

    <div id="feed-error" class="hidden py-8 text-center text-red-500">
      Failed to load news feed. Please try again later.
    </div>

    <div id="feed-container" class="hidden"></div>
  </main>
</Layout>

<style>
  .news-card {
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 16px 18px;
    background: var(--background);
    transition: box-shadow 0.2s;
  }
  .news-card:hover {
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }
  .news-source {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.6;
  }
  .news-headline {
    font-size: 17px;
    font-weight: 600;
    margin-top: 4px;
    color: var(--foreground);
    cursor: pointer;
  }
  .news-headline:hover {
    color: var(--accent, #4f46e5);
    text-decoration: underline;
  }
  .news-headline-zh {
    font-size: 16px;
    font-weight: 500;
    margin-top: 6px;
    color: var(--foreground);
    opacity: 0.85;
    cursor: pointer;
  }
  .news-headline-zh:hover {
    color: var(--accent, #4f46e5);
    text-decoration: underline;
  }
  .news-summary {
    font-size: 14px;
    margin-top: 6px;
    line-height: 1.6;
    opacity: 0.8;
  }
  .news-meta {
    font-size: 12px;
    margin-top: 10px;
    opacity: 0.5;
  }
  .news-link {
    display: inline-block;
    margin-top: 10px;
    padding: 5px 12px;
    font-size: 13px;
    border-radius: 6px;
    background: var(--accent);
    color: white;
    text-decoration: none;
  }
  .news-link:hover {
    opacity: 0.85;
  }
  .market-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
    margin: 12px 0;
  }
  .market-item {
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
  }
  .market-name {
    font-size: 13px;
    font-weight: 600;
  }
  .market-price {
    font-size: 18px;
    font-weight: 700;
    margin-top: 2px;
  }
  .market-change {
    font-size: 13px;
    margin-top: 2px;
  }
  .section-header {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 700;
    margin-top: 20px;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  .summary-box {
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 14px 18px;
    font-size: 15px;
    line-height: 1.7;
    margin-bottom: 16px;
  }
  .recommendation-box {
    border: 1px solid #16a34a40;
    border-left: 4px solid #16a34a;
    border-radius: 8px;
    padding: 14px 18px;
    font-size: 14px;
    line-height: 1.7;
    margin-bottom: 16px;
    white-space: pre-line;
  }
  .edition-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 14px 18px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--background);
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    color: var(--foreground);
    transition: background 0.15s;
  }
  .edition-toggle:hover {
    background: var(--border);
  }
  .edition-toggle .arrow {
    transition: transform 0.2s;
    font-size: 12px;
    opacity: 0.5;
  }
  .edition-toggle .arrow.open {
    transform: rotate(90deg);
  }
  .edition-body {
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .edition-body.collapsed {
    max-height: 0 !important;
  }
  .edition-meta {
    font-size: 13px;
    opacity: 0.55;
    font-weight: 400;
  }
</style>

<script is:inline>
  const FEED_URL =
    "https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.json";

  async function loadFeed() {
    var loading = document.getElementById("feed-loading");
    var error = document.getElementById("feed-error");
    var container = document.getElementById("feed-container");

    try {
      var res = await fetch(FEED_URL + "?t=" + Date.now());
      if (!res.ok) throw new Error("HTTP " + res.status);
      var feed = await res.json();

      loading.classList.add("hidden");

      // Normalize: support both old single-edition and new editions format
      var editions;
      if (feed.editions && Array.isArray(feed.editions)) {
        editions = feed.editions;
      } else if (feed.items) {
        editions = [feed];
      } else {
        editions = [];
      }

      if (editions.length === 0) {
        container.innerHTML = '<p class="py-8 text-center opacity-60">No editions available yet.</p>';
        container.classList.remove("hidden");
        return;
      }

      // Sort editions newest first
      editions.sort(function (a, b) {
        return (b.updated_at || "").localeCompare(a.updated_at || "");
      });

      var html = "";
      for (var idx = 0; idx < editions.length; idx++) {
        var edition = editions[idx];
        var isFirst = idx === 0;
        var editionId = "edition-" + idx;

        // Format the edition date and label
        var dateStr = "";
        if (edition.updated_at) {
          var d = new Date(edition.updated_at);
          dateStr = d.toLocaleDateString("en-US", {
            weekday: "short",
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        }
        var label = edition.edition_label || "Edition";
        var itemCount = (edition.items || []).length;

        // Edition header (toggle button)
        html +=
          '<div style="margin-top:' + (idx === 0 ? "0" : "16px") + ';">' +
          '<button class="edition-toggle" data-target="' + editionId + '">' +
          "<span>" + escapeHtml(label) +
          ' <span class="edition-meta">' + dateStr +
          " &middot; " + itemCount + " items</span></span>" +
          '<span class="arrow' + (isFirst ? " open" : "") + '">&#9654;</span>' +
          "</button>";

        // Edition body
        html += '<div id="' + editionId + '" class="edition-body' + (isFirst ? "" : " collapsed") + '">';

        // Summary section
        html += renderEditionSummary(edition);

        // News items
        if (edition.items && edition.items.length > 0) {
          html += '<div class="section-header" style="margin-top:16px;">Top Briefing</div>';
          html += '<div style="display:flex;flex-direction:column;gap:12px;">';
          for (var j = 0; j < edition.items.length; j++) {
            html += renderNewsCard(edition.items[j]);
          }
          html += "</div>";
        }

        html += "</div>"; // edition-body
        html += "</div>"; // wrapper
      }

      container.innerHTML = html;
      container.classList.remove("hidden");

      // Wire up toggle buttons
      var toggles = container.querySelectorAll(".edition-toggle");
      for (var t = 0; t < toggles.length; t++) {
        toggles[t].addEventListener("click", handleToggle);
      }
    } catch (e) {
      console.error("Failed to load feed:", e);
      loading.classList.add("hidden");
      error.classList.remove("hidden");
    }
  }

  function handleToggle(e) {
    var btn = e.currentTarget;
    var targetId = btn.getAttribute("data-target");
    var body = document.getElementById(targetId);
    var arrow = btn.querySelector(".arrow");
    if (!body) return;

    if (body.classList.contains("collapsed")) {
      body.classList.remove("collapsed");
      body.style.maxHeight = body.scrollHeight + "px";
      if (arrow) arrow.classList.add("open");
    } else {
      body.style.maxHeight = body.scrollHeight + "px";
      // Force reflow then collapse
      body.offsetHeight;
      body.classList.add("collapsed");
      body.style.maxHeight = "0";
      if (arrow) arrow.classList.remove("open");
    }
  }

  function renderEditionSummary(edition) {
    var html = "";

    if (edition.summary_cn) {
      html += '<div class="section-header">Daily Outlook</div>';
      html += '<div class="summary-box">' + escapeHtml(edition.summary_cn) + "</div>";
    }

    if (edition.sector_recommendation) {
      html += '<div class="section-header">Sector & Stock Picks</div>';
      html +=
        '<div class="recommendation-box">' +
        escapeHtml(edition.sector_recommendation) +
        "</div>";
    }

    // Market snapshot
    if (edition.market_snapshot && edition.market_snapshot.length > 0) {
      html += '<div class="section-header">Market Snapshot</div>';
      for (var s = 0; s < edition.market_snapshot.length; s++) {
        var section = edition.market_snapshot[s];
        html +=
          '<div style="font-size:12px;opacity:0.6;margin-top:12px;text-transform:uppercase;letter-spacing:1px;">' +
          escapeHtml(section.title) + "</div>";
        html += '<div class="market-grid">';
        for (var i = 0; i < section.items.length; i++) {
          var item = section.items[i];
          var priceStr = item.price != null ? item.price.toFixed(2) : "N/A";
          var changeStr =
            item.change != null && item.change_percent != null
              ? (item.change >= 0 ? "+" : "") +
                item.change.toFixed(2) +
                " (" +
                (item.change_percent >= 0 ? "+" : "") +
                item.change_percent.toFixed(2) +
                "%)"
              : "N/A";
          var color = item.change_color || (item.change >= 0 ? "#16a34a" : "#dc2626");
          html +=
            '<div class="market-item">' +
            '<div class="market-name">' + escapeHtml(item.name) +
            ' <span style="opacity:0.5;font-weight:400;">' + escapeHtml(item.symbol) + "</span></div>" +
            '<div class="market-price">' + priceStr + "</div>" +
            '<div class="market-change" style="color:' + color + ';">' + changeStr + "</div>" +
            "</div>";
        }
        html += "</div>";
      }
    }

    // Sector rankings
    if (edition.sector_rankings && edition.sector_rankings.length > 0) {
      html += '<div class="section-header">Sector Rankings</div>';
      for (var r = 0; r < edition.sector_rankings.length; r++) {
        var ranking = edition.sector_rankings[r];
        html +=
          '<div style="font-size:12px;opacity:0.6;margin-top:12px;text-transform:uppercase;letter-spacing:1px;">' +
          escapeHtml(ranking.title) + "</div>";
        html += '<div style="margin:8px 0 16px;">';
        for (var ri = 0; ri < ranking.items.length; ri++) {
          var rItem = ranking.items[ri];
          var rColor = rItem.change_color || (rItem.change_percent >= 0 ? "#16a34a" : "#dc2626");
          html +=
            '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);">' +
            '<span><span style="opacity:0.5;font-size:12px;">' + (ri + 1) + ".</span> " + escapeHtml(rItem.name) + "</span>" +
            '<span style="font-weight:700;color:' + rColor + ';">' +
            (rItem.change_percent >= 0 ? "+" : "") + rItem.change_percent.toFixed(2) + "%" +
            "</span></div>";
        }
        html += "</div>";
      }
    }

    return html;
  }

  function renderNewsCard(item) {
    var pubDate = item.published
      ? new Date(item.published).toLocaleString()
      : "";
    var titleEn = item.title_en || item.title || "";
    var titleZh = item.title_zh || "";
    var summaryEn = item.summary_en || "";
    var summaryZh = item.summary_zh || "";

    return (
      '<div class="news-card">' +
      '<div class="news-source">' + escapeHtml(item.source) + "</div>" +
      '<a class="news-headline" href="' + escapeHtml(item.link) + '" target="_blank" rel="noopener" style="display:block;text-decoration:none;color:inherit;">' + escapeHtml(titleEn) + "</a>" +
      (titleZh ? '<a class="news-headline-zh" href="' + escapeHtml(item.link) + '" target="_blank" rel="noopener" style="display:block;text-decoration:none;color:inherit;">' + escapeHtml(titleZh) + "</a>" : "") +
      (summaryEn ? '<div class="news-summary"><strong>EN:</strong> ' + escapeHtml(summaryEn) + "</div>" : "") +
      (summaryZh ? '<div class="news-summary"><strong>CN:</strong> ' + escapeHtml(summaryZh) + "</div>" : "") +
      '<div class="news-meta">' + pubDate + "</div>" +
      "</div>"
    );
  }

  function escapeHtml(text) {
    if (!text) return "";
    var div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  loadFeed();

  // Email subscription handler
  var subscribeForm = document.getElementById("subscribe-form");
  if (subscribeForm) {
    subscribeForm.addEventListener("submit", function (e) {
      e.preventDefault();
      var emailInput = document.getElementById("subscribe-email");
      var msg = document.getElementById("subscribe-msg");
      var email = emailInput.value.trim();
      if (!email) return;

      msg.textContent = "Subscribing...";
      msg.className = "mt-2 text-sm opacity-60";
      msg.classList.remove("hidden");

      fetch("/api/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: email }),
      })
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (data.ok) {
            msg.textContent = "Subscribed! You'll receive the next digest.";
            msg.className = "mt-2 text-sm text-green-600";
            emailInput.value = "";
          } else {
            msg.textContent = data.error || "Failed to subscribe. Please try again.";
            msg.className = "mt-2 text-sm text-red-500";
          }
        })
        .catch(function () {
          msg.textContent = "Network error. Please try again later.";
          msg.className = "mt-2 text-sm text-red-500";
        });
    });
  }
</script>
