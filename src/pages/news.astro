---
import Layout from "~/layouts/PageLayout.astro";
---

<Layout metadata={{ title: "Finance News Feed" }}>
  <main class="mx-auto max-w-5xl px-4 pb-12 sm:px-6">
    <!-- Hero -->
    <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-indigo-50 via-white to-blue-50 dark:from-indigo-950/30 dark:via-slate-900 dark:to-blue-950/20 p-6 sm:p-8 mt-6 mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold sm:text-3xl font-heading bg-gradient-to-r from-indigo-600 to-blue-500 dark:from-indigo-400 dark:to-blue-400 bg-clip-text text-transparent">Finance News Feed</h1>
          <p class="text-muted mt-1 text-sm">Global financial headlines, updated twice daily.</p>
        </div>
        <a
          href="https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.xml"
          target="_blank"
          rel="noopener"
          class="inline-flex items-center gap-1.5 rounded-full bg-orange-500 px-4 py-1.5 text-xs font-semibold text-white hover:bg-orange-600 transition-colors self-start"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
          RSS
        </a>
      </div>
    </div>

    <!-- Subscribe -->
    <details class="mb-6 rounded-lg border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800/50">
      <summary class="cursor-pointer px-4 py-3 text-sm font-semibold text-muted select-none">Subscribe to email digest</summary>
      <form id="subscribe-form" class="flex flex-col gap-2 sm:flex-row px-4 pb-4">
        <input type="email" id="subscribe-email" placeholder="your@email.com" required
          class="flex-1 rounded-md border border-gray-200 dark:border-slate-600 bg-transparent px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none" />
        <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700 transition-colors">Subscribe</button>
      </form>
      <p id="subscribe-msg" class="hidden px-4 pb-3 text-sm"></p>
    </details>

    <div id="feed-loading" class="py-12 text-center text-muted">Loading latest news...</div>
    <div id="feed-error" class="hidden py-8 text-center text-red-500">Failed to load news feed.</div>
    <div id="feed-container" class="hidden"></div>
  </main>
</Layout>

<style>
  /* Compact news item row */
  .news-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(128,128,128,0.12);
    transition: background 0.15s;
  }
  .news-row:last-child { border-bottom: none; }
  .news-row:hover { background: rgba(79,70,229,0.03); }
  .news-time {
    font-size: 11px;
    color: rgba(128,128,128,0.7);
    min-width: 44px;
    padding-top: 2px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .news-body { flex: 1; min-width: 0; }
  .news-title-link {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.4;
    color: var(--aw-color-text-default, #1e293b);
    text-decoration: none;
    display: block;
  }
  .news-title-link:hover { color: rgb(79 70 229); }
  :global(.dark) .news-title-link { color: var(--aw-color-text-default, #cbd5e1); }
  :global(.dark) .news-title-link:hover { color: rgb(129 140 248); }
  .news-title-zh {
    font-size: 13px;
    color: rgba(128,128,128,0.75);
    margin-top: 1px;
    line-height: 1.4;
  }
  .news-source-badge {
    display: inline-block;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1px 6px;
    border-radius: 3px;
    background: rgba(79,70,229,0.08);
    color: rgb(79 70 229);
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 2px;
  }
  :global(.dark) .news-source-badge {
    background: rgba(129,140,248,0.12);
    color: rgb(129 140 248);
  }
  /* Sections */
  .feed-section {
    background: white;
    border: 1px solid rgba(128,128,128,0.12);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
  }
  :global(.dark) .feed-section {
    background: rgba(30,41,59,0.5);
    border-color: rgba(128,128,128,0.15);
  }
  .feed-section-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 700;
    color: rgb(79 70 229);
    margin-bottom: 8px;
  }
  :global(.dark) .feed-section-title { color: rgb(129 140 248); }
  /* Summary box */
  .feed-summary {
    font-size: 14px;
    line-height: 1.7;
    color: var(--aw-color-text-default);
    white-space: pre-line;
  }
  /* Market grid */
  .market-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 6px;
  }
  .market-chip {
    border: 1px solid rgba(128,128,128,0.12);
    border-radius: 8px;
    padding: 8px 10px;
    background: rgba(249,250,251,0.5);
  }
  :global(.dark) .market-chip { background: rgba(15,23,42,0.3); }
  .market-chip-name { font-size: 11px; font-weight: 600; opacity: 0.7; }
  .market-chip-price { font-size: 16px; font-weight: 700; margin-top: 1px; }
  .market-chip-change { font-size: 11px; margin-top: 1px; }
  /* Edition toggle */
  .edition-toggle {
    display: flex; align-items: center; justify-content: space-between;
    width: 100%; padding: 12px 16px;
    border: 1px solid rgba(128,128,128,0.12); border-radius: 10px;
    background: white; cursor: pointer;
    font-size: 15px; font-weight: 600;
    color: var(--aw-color-text-default, #1e293b);
    transition: background 0.15s;
  }
  :global(.dark) .edition-toggle { background: rgba(30,41,59,0.5); color: var(--aw-color-text-default, #cbd5e1); border-color: rgba(128,128,128,0.15); }
  .edition-toggle:hover { background: rgba(79,70,229,0.04); }
  :global(.dark) .edition-toggle:hover { background: rgba(129,140,248,0.06); }
  .edition-toggle .arrow { transition: transform 0.2s; font-size: 11px; opacity: 0.4; }
  .edition-toggle .arrow.open { transform: rotate(90deg); }
  .edition-meta { font-size: 12px; opacity: 0.5; font-weight: 400; }
  .edition-body { overflow: hidden; transition: max-height 0.3s ease; }
  .edition-body.collapsed { max-height: 0 !important; }
  /* Sector ranking row */
  .sector-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 3px 0; font-size: 13px;
  }
  .sector-row + .sector-row { border-top: 1px solid rgba(128,128,128,0.08); }
</style>

<script is:inline>
  var FEED_URL = "https://raw.githubusercontent.com/james20141606/ai_finance_news/main/news-feed.json";

  async function loadFeed() {
    var loading = document.getElementById("feed-loading");
    var error = document.getElementById("feed-error");
    var container = document.getElementById("feed-container");
    try {
      var res = await fetch(FEED_URL + "?t=" + Date.now());
      if (!res.ok) throw new Error("HTTP " + res.status);
      var feed = await res.json();
      loading.classList.add("hidden");

      var editions = (feed.editions && Array.isArray(feed.editions)) ? feed.editions : (feed.items ? [feed] : []);
      if (!editions.length) { container.innerHTML = '<p class="py-8 text-center text-muted">No editions yet.</p>'; container.classList.remove("hidden"); return; }

      editions.sort(function(a,b){ return (b.updated_at||"").localeCompare(a.updated_at||""); });

      var html = "";
      for (var idx = 0; idx < editions.length; idx++) {
        var ed = editions[idx], isFirst = idx === 0, edId = "edition-" + idx;
        var dateStr = ed.updated_at ? new Date(ed.updated_at).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}) : "";
        var label = ed.edition_label || "Edition";
        var count = (ed.items||[]).length;

        html += '<div style="margin-top:' + (idx?12:0) + 'px;">';
        html += '<button class="edition-toggle" data-target="' + edId + '"><span>' + esc(label) + ' <span class="edition-meta">' + dateStr + ' &middot; ' + count + ' items</span></span><span class="arrow' + (isFirst?" open":"") + '">&#9654;</span></button>';
        html += '<div id="' + edId + '" class="edition-body' + (isFirst?"":" collapsed") + '" style="margin-top:8px;">';

        // Summary
        if (ed.summary_cn) {
          html += '<div class="feed-section"><div class="feed-section-title">Daily Outlook</div><div class="feed-summary">' + esc(ed.summary_cn) + '</div></div>';
        }
        if (ed.sector_recommendation) {
          html += '<div class="feed-section"><div class="feed-section-title">Sector & Stock Picks</div><div class="feed-summary">' + esc(ed.sector_recommendation) + '</div></div>';
        }

        // Market
        if (ed.market_snapshot && ed.market_snapshot.length) {
          html += '<div class="feed-section"><div class="feed-section-title">Market Snapshot</div>';
          for (var s=0;s<ed.market_snapshot.length;s++) {
            var sec = ed.market_snapshot[s];
            html += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;opacity:0.5;margin:8px 0 4px;">' + esc(sec.title) + '</div><div class="market-grid">';
            for (var i=0;i<sec.items.length;i++) {
              var m = sec.items[i];
              var pr = m.price!=null?m.price.toFixed(2):"N/A";
              var ch = (m.change!=null&&m.change_percent!=null) ? ((m.change>=0?"+":"")+m.change.toFixed(2)+" ("+(m.change_percent>=0?"+":"")+m.change_percent.toFixed(2)+"%)") : "";
              var co = m.change_color||(m.change>=0?"#16a34a":"#dc2626");
              html += '<div class="market-chip"><div class="market-chip-name">' + esc(m.name) + '</div><div class="market-chip-price">' + pr + '</div>' + (ch?'<div class="market-chip-change" style="color:'+co+';">'+ch+'</div>':'') + '</div>';
            }
            html += '</div>';
          }
          html += '</div>';
        }

        // Sectors
        if (ed.sector_rankings && ed.sector_rankings.length) {
          html += '<div class="feed-section"><div class="feed-section-title">Sector Rankings</div>';
          for (var r=0;r<ed.sector_rankings.length;r++) {
            var rk = ed.sector_rankings[r];
            html += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;opacity:0.5;margin:8px 0 4px;">' + esc(rk.title) + '</div>';
            for (var ri=0;ri<rk.items.length;ri++) {
              var si = rk.items[ri]; var sc = si.change_color||(si.change_percent>=0?"#16a34a":"#dc2626");
              html += '<div class="sector-row"><span><span style="opacity:0.4;font-size:11px;">' + (ri+1) + '.</span> ' + esc(si.name) + '</span><span style="font-weight:700;color:'+sc+';">' + (si.change_percent>=0?"+":"") + si.change_percent.toFixed(2) + '%</span></div>';
            }
          }
          html += '</div>';
        }

        // News items - compact list
        if (ed.items && ed.items.length) {
          html += '<div class="feed-section"><div class="feed-section-title">Top Briefing (' + ed.items.length + ')</div>';
          for (var j=0;j<ed.items.length;j++) { html += renderRow(ed.items[j]); }
          html += '</div>';
        }

        html += '</div></div>';
      }

      container.innerHTML = html;
      container.classList.remove("hidden");
      var toggles = container.querySelectorAll(".edition-toggle");
      for (var t=0;t<toggles.length;t++) toggles[t].addEventListener("click", handleToggle);
    } catch(e) { console.error(e); loading.classList.add("hidden"); error.classList.remove("hidden"); }
  }

  function renderRow(item) {
    var titleEn = item.title_en || item.title || "";
    var titleZh = item.title_zh || "";
    var timeStr = "";
    if (item.published) {
      var d = new Date(item.published);
      var h = d.getHours(), m = d.getMinutes();
      timeStr = (h<10?"0":"") + h + ":" + (m<10?"0":"") + m;
    }
    return '<div class="news-row">' +
      '<div class="news-time">' + timeStr + '</div>' +
      '<div class="news-body">' +
        '<a class="news-title-link" href="' + esc(item.link) + '" target="_blank" rel="noopener">' + esc(titleEn) + '</a>' +
        (titleZh && titleZh !== titleEn ? '<div class="news-title-zh">' + esc(titleZh) + '</div>' : '') +
      '</div>' +
      '<div class="news-source-badge">' + esc(item.source) + '</div>' +
    '</div>';
  }

  function handleToggle(e) {
    var btn = e.currentTarget, id = btn.getAttribute("data-target");
    var body = document.getElementById(id), arrow = btn.querySelector(".arrow");
    if (!body) return;
    if (body.classList.contains("collapsed")) {
      body.classList.remove("collapsed"); body.style.maxHeight = body.scrollHeight + "px";
      if (arrow) arrow.classList.add("open");
    } else {
      body.style.maxHeight = body.scrollHeight + "px"; body.offsetHeight;
      body.classList.add("collapsed"); body.style.maxHeight = "0";
      if (arrow) arrow.classList.remove("open");
    }
  }

  function esc(t) { if (!t) return ""; var d = document.createElement("div"); d.textContent = t; return d.innerHTML; }

  loadFeed();

  // Subscribe
  var sf = document.getElementById("subscribe-form");
  if (sf) sf.addEventListener("submit", function(e) {
    e.preventDefault();
    var ei = document.getElementById("subscribe-email"), msg = document.getElementById("subscribe-msg"), em = ei.value.trim();
    if (!em) return;
    msg.textContent = "Subscribing..."; msg.className = "px-4 pb-3 text-sm text-muted"; msg.classList.remove("hidden");
    fetch("/api/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:em})})
      .then(function(r){return r.json();})
      .then(function(d){ if(d.ok){msg.textContent="Subscribed!";msg.className="px-4 pb-3 text-sm text-green-600";ei.value="";}else{msg.textContent=d.error||"Failed.";msg.className="px-4 pb-3 text-sm text-red-500";}})
      .catch(function(){msg.textContent="Network error.";msg.className="px-4 pb-3 text-sm text-red-500";});
  });
</script>
